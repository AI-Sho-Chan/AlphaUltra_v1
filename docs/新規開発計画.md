# 新規開発計画（PIVOT版 v3.1）
AlphaUltra / AlphaAI  
更新日: 2025-08-31

---

## 1. 目的と到達目標
**定性（TDNET適時開示/EDINET/EDGAR/ニュース）×定量（価格/ファンダ）**の融合で、次を高精度に発見・配信する。最終目標は**アラートPPV≥80%**。

- ① **1年で株価2倍**候補（y_2x）  
- ② **3–5年でテンバガー**候補（y_10x；12–24か月の早期兆候も併用）  
- ③ **S&P500を超過**（1M/3M/12M）候補（相対リターン）

到達基準（初期）：
- Walk‑Forwardで**ネットSharpe>0**、**DSR>0**
- Precision@K（K=1%）≥ 0.20（y_2x）
- 相対超過Hit‑Rate：1M/3M/12Mで **>55/60/65%**
- 校正後のPPV‑Coverage曲線から**PPV≥80%**の閾値θ*を運用設定

---

## 2. スコープと非スコープ
- **一次情報はTDNET（株探由来データ）を主軸**。TDNET公式APIは**不使用**（コスト回避）。  
- EDINET/EDGARは**中期文脈差分**に限定（定期報告）。  
- ニュース（見出し最小）は補助。  
- 価格・企業アクション・指数は標準取得（Yahoo等）。

非スコープ（現段階）:
- 超低流動・仕手銘柄の短期スキャル最適化
- HFT/逐次ティック依存の戦略

---

## 3. ユニバース方針（二系統）
**Track‑A: Hyper‑Growth Discovery（発見）**  
- 対象：**JP Growth＋JP Standard（高流動性サブセット）**, **US Russell 2000 Growth＋NASDAQ（高流動性サブセット）**  
- 目的：①②（2x/10x）早期兆候の取りこぼし回避  
- 高流動性（暫定）：ADDV 3M **JP≥1億円 / US≥$2M**、価格 **JP≥200円 / US≥$2**、スプレッド中央値≤50bps

**Track‑B: Benchmark Outperform（運用）**  
- 対象：**S&P500＋JP Prime**  
- 目的：③（相対超過）と運用安定性（キャパシティ）

**Wave展開**  
- Wave‑0：Aの液体サンプル200銘柄（JP100/US100）＋Bの代表100銘柄（配管確認）  
- Wave‑1：A=上記フル、B=S&P500+JP Prime  
- Wave‑2：AにJP小型（液体ゾーン）追加、BにRussell1000/JP Standard拡張  
- Wave‑3：研究枠として超小型（運用には使わない）

---

## 4. データソースと時間規範
### 4.1 TDNET（株探由来データ）
- フィールド例：`code`（4桁）/`title`/`published_at_jst`/`urls.pdf`/`urls.detail`/`body`（取得可能範囲）/推定`event_type`  
- 保存：`data/raw/tdnet/YYYY/MM/DD/<code>.json`（UTF‑8）  
- **タイムスタンプ規範**：JSTの発表時刻をソース・オブ・トゥルース。**T+1寄り以降**に影響開始。  
- マッピング：`{code}.T` をJPティッカーへ正規化。

### 4.2 EDINET/EDGAR/ニュース
- EDINET/EDGAR：`acceptanceDateTime / submitDateTime`、取得不可時は**提出日EOD**で保守的処理。  
- ニュース：`published_at`。TDNET重複は排除。

### 4.3 価格・指数・カレンダー
- 日次OHLCV、企業アクション（分割/配当等）を調整。  
- 指数はSPY（US）/TOPIX代理（必要に応じ）。  
- 取引所カレンダー（JPX/NYSE/Nasdaq）で**営業日整合**。

---

## 5. 特徴量設計
### 5.1 TDNETイベント特徴
- **イベント種別ワンホット**：決算短信、業績予想修正（上方/下方）、配当（増配/減配）、自社株買い、増資/CB（希薄化）、M&A/子会社、設備投資、大型受注/契約、提携/共同、承認/新製品、人事（CEO/CFO）、不祥事/訴訟 等。  
- **極性**：ポジ/ネガ、希薄化フラグ。  
- **強度**：金額/規模の**比率化**（例：買付総額/時価総額、投資額/売上、配当増額率）。  
- **新規性**：自社過去1年の同種イベント群に対する**KL/JS/コサイン差分**、語彙新規語率。  
- **時刻ゲート**：
  - `gate = clip(1 + α·event_strength + β·novelty, 0.5, 2.0)`  
  - 適用窓：発表当日〜N営業日（N初期=3、探索5まで）  
  - ネガ/希薄化は**抑制ゲート**（重み<1）

### 5.2 定量特徴
- モメンタム：12‑1/6‑1/3‑1、短期反転（5D）  
- リスク：20D/60Dボラ、β、IdioVol  
- 残差モメンタム：市場/セクター回帰残差  
- 流動性：ADDV、回転率、スプレッド代理  
- （将来）品質/バリュー：ROE/利益率/アクルーアル、EV/EBIT, P/E, P/B（財務取り込み後）

### 5.3 文書差分（中期）
- EDINET/EDGAR：MD&A/事業/リスクの**前年差分**（コサイン、KL/JS）、Loughran‑McDonald辞書スコア。

---

## 6. ラベリング
- `P_adj[t]`：分割/配当調整済み終値。  
- **y_2x**：`1 if max(P[t+1..t+252])/P[t] ≥ 2.0 else 0`  
- **y_10x**：`1 if max(P[t+1..t+1260])/P[t] ≥ 10.0 else 0`（早期兆候は12–24Mの3–5倍達成率でも評価）  
- **相対超過**：`R_rel(k)=R_stock(k)−R_bench(k)`（k=21/63/252）。閾値 `{+10%, +20%, +50%}` の到達フラグ + 連続値。  
- 追加：到達まで営業日、途中DD 最大値。

**結合規範**：`merge_asof(direction="forward", tolerance=1D, by="ticker")` で**T+1寄り整合**。

---

## 7. 検証設計と指標
- **時系列CV**：Purged/Embargo（y_2x: 20–30D、y_10x: 長め）。**クラスタPurge**（GICS/相関クラスタ）。  
- **Walk‑Forward**：Train 5y → Valid 6m → スライド。  
- **不均衡**：クラス重み、サンプルUniqueness重み、難例リサンプリング（慎重に）。  
- **指標**：AUC‑ROC/PR、P@K（1%/5%）、トップKロングのネットSharpe、**DSR**、到達日数分布。  
- **Ablation**：TDNETのみ／定量のみ／融合、ゲート有無。  
- **リーケージ検査**：発表前の定性は**完全マスク**、時刻境界の乱用不可。

---

## 8. 校正と閾値
- OOF予測→**Isotonic Regression**で校正。  
- **PPV‑Coverage曲線**からPPV≥80%を満たす最小スコアθ*を選定。  
- しきい値は `configs/thresholds.yaml` に固定、**月次で再校正**。

---

## 9. モデリング
- 多タスク：{ 2x/10x 到達確率, 到達まで日数, 相対超過マージン }  
- 候補：LightGBM/CatBoost（数値＋カテゴリ）、Late‑Fusion（数値＋埋め込み）、サバイバル（DeepSurv系）  
- ゲート融合：`score = f(quant) * gate`（安定化のため**clip**必須）  
- 監視：特徴重要度の**安定性**、Shapley drift、DSR推移。

---

## 10. ディレクトリ構成（固定）
```
configs/
  base.yaml            # パス/共通設定
  tdnet.yaml           # TDNET取込/特徴
  model.yaml           # モデル/検証
  thresholds.yaml      # 運用しきい値
data/
  raw/
    prices/*.parquet
    tdnet/YYYY/MM/DD/*.json
    edinet/**            # 最小
  proc/
    adj_prices/*.parquet
    features_tdnet/tdnet_event_features.parquet
    features_quant.parquet
    features_text/*.parquet
    labels/targets.parquet
    dataset/dataset_final.parquet
reports/
  checks/*.log, *.csv, *.json
docs/
  HANDOFF.md, UNIVERSE_POLICY.md, EVENT_TAXONOMY.md, NEXT_STEPS_TDNET.md
```

---

## 11. 実行SOP（要点）
1) **TDNET取込**：株探エクスポート→`scripts/tdnet_ingest.py` が `data/raw/tdnet/...` へ正規化  
2) **TDNET特徴**：`scripts/tdnet_features.py`（種別/極性/強度/新規性/ゲート）→ `features_tdnet/`  
3) **定量特徴**：`scripts/features_quant.py` → `features_quant.parquet`  
4) **ラベル**：`scripts/labels_make.py`（y_2x/10x/rel）  
5) **結合**：`scripts/features_join.py`（asof forward, T+1）→ `dataset_final.parquet`  
6) **検証**：`scripts/walkforward_lgbm.py`（Purged/Embargo/クラスタPurge）→ `wf_*`  
7) **校正**：`scripts/calibrate_thresholds.py` → `thresholds.yaml`

ログは `reports/checks/*.log` に固定。共有は**コミットSHA＋ログ末尾20行＋成果物存在チェック**。

---

## 12. ガードレールと切り捨て基準
- コスト：US往復10bps、JP往復15bpsを常時控除。  
- 流動性：ADDV/価格/スプレッド基準を満たさない銘柄は**学習/運用とも除外**。  
- 切り捨て：
  - WFで**DSR≤0が連続2期**  
  - 校正後PPV≥80%帯の**カバレッジ極小**（≪1件/日）  
  - TDNETイベントの寄与がAblationで**有意でない**（P@K差<+1pp 等）

---

## 13. 3週間ロードマップ（PIVOT版）
- **T0–T2**：TDNET取込基盤（株探→正規化）、イベント分類辞書、初期ゲート実装  
- **T3–T4**：量的特徴＋TDNET特徴のLate‑Fusionで**ベースライン**作成、ラベル作成、結合  
- **T5–T6**：Purged/Embargo CV＋Walk‑Forward＋DSR、A/Bトラック別に評価  
- **T7**：校正（Isotonic）＋PPV‑Coverageで運用閾値設定、Ablationで要因確認  
- **T8–T14**：ゲートα/β探索、イベント新規性/強度の改良、エッジケース対策  
- **T15–T21**：ユニバースWave拡大、安定度/キャパシティ検証、初回出荷判定

---

## 14. 環境と変数
- Python 3.11、numpy 1.26.4、pandas 2.2.2、pyarrow 16.1.0、lightgbm 等  
- 環境変数：
  - `SEC_USER_AGENT`（EDGAR礼儀UA）
  - `EDINET_API_KEY`（必要時）
  - `KABUTAN_EXPORT_DIR` 等（株探エクスポート受け口; 運用で調整）

---

## 15. 付録（ドラフト）
### 15.1 EVENT_TAXONOMY（抜粋）
- Earnings, GuidanceUp/Down, DividendUp/Down, Buyback, EquityOffering/CB, M&A/Spin‑off, Investment/Capex, LargeOrder, Partnership, Product/Approval, ExecutiveChange, Litigation/Scandal …

### 15.2 configs/tdnet.yaml キー例
```yaml
paths:
  tdnet_raw: data/raw/tdnet
  tdnet_features: data/proc/features_tdnet/tdnet_event_features.parquet
params:
  gate_days: 3
  clip_min: 0.5
  clip_max: 2.0
  alpha_strength: 0.6
  beta_novelty: 0.4
```

---

本ドキュメントは**プロジェクトの唯一の仕様**（憲法）として扱う。更新はPRで行うこと。
